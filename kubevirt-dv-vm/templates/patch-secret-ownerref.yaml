{{- range $i, $val := .Values.dataVolume.storageClasses }}
apiVersion: batch/v1
kind: Job
metadata:
  name: patch-secret-ownerref-{{ $val }}
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "5"
spec:
  template:
    spec:
      containers:
      - name: patch-secret
        image: bitnami/kubectl:latest
        command:
        - /bin/sh
        - -c
        - |
          VM_UID=$(kubectl get vm vm-{{ $val }} -o jsonpath='{.metadata.uid}')
          kubectl patch secret vm-user-credentials --type=json -p='[{"op": "add", "path": "/metadata/ownerReferences", "value":[{"apiVersion": "kubevirt.io/v1", "kind": "VirtualMachine", "name": "vm-nfs-standard", "uid": "'${VM_UID}'"}]}]'
      restartPolicy: OnFailure
---
{{ end -}}