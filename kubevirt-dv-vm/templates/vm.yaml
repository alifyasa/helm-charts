{{- range $i, $val := .Values.dataVolume.storageClasses }}
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  name: vm-{{ $val }}
spec:
  running: true
  template:
    spec:
      domain:
        devices:
          disks:
            - name: containerdisk
              disk:
                bus: virtio
            - name: cloudinitdisk
              disk:
                bus: virtio
          interfaces:
            - masquerade: {}
              name: defaultnetwork
        resources:
          requests:
            memory: 4Gi
            cpu: 2
          limits:
            memory: 4Gi
            cpu: 2
      networks:
        - name: defaultnetwork
          pod: {}
      volumes:
        - name: containerdisk
          dataVolume:
            name: dv-{{ $val }}
        - name: cloudinitdisk
          cloudInitNoCloud:
            userData: |-
              #cloud-config
        - name: cloudinitdisk
          cloudInitNoCloud:
            # alifyasa:ubuntu
            # Thanks to https://stackoverflow.com/a/61868231
            userData: |
              #cloud-config
              users:
                - default
                - name: alifyasa
                  passwd: "$y$j9T$bcUpk08btOwDcf28KTvBa.$QHDBpTFIwnrl7QGXKPd5ymNezTLGMguRLmxQV/H.XW9"
                  shell: /bin/bash
                  lock-passwd: false
                  ssh_pwauth: True
                  chpasswd: { expire: False }
                  sudo: ALL=(ALL) NOPASSWD:ALL
                  groups: users, admin
              autoinstall:
                  version: 1
                  refresh-installer:
                      update: yes
---
{{ end -}}
